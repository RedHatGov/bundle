Hi Ramon, Tony,

I did a time-boxed analysis for this request, with the goal of determining the feasibility and complexity.

There's an ambiguity in the RFE about what is meant by authenticating by certificates. Two things might match: 
* Mutual TLS: compared to TLS, where the client uses a server certificate to ensure the server's identity, mutual TLS handshake implies that the server does the same, and verifies the client's identity with a client certificate
* User authentication: Instead of using a username and password, or a token (JWT, OAuth, OIDC, etc), the user authentication is done with a certificate.

# User authentication by certificate

Here's a list of tasks that will be required:

| Task | Difficulty | Description|
|---|---|---|
| Test Env | Medium | [Setup Test env](#Setup-Test-env)|
| Verify `containers/image` support | Large | [containers/image support](#containers/image-support) |
| Complete support | XLarge | [Complete support](#Complete-support)|

## Setup Test env
setting up a test environment with a registry that accepts authentication by client certificates is hard.
* This is needed both for dev and QE
* It's not 100% sure how to do that but we might be needing
** a standalone Quay
** an identity provider? keycloak maybe, which suports x509 client cert authentication
** Setup quay authentication through IDP [doc](https://docs.redhat.com/en/documentation/red_hat_quay/3/html/manage_red_hat_quay/configuring-oidc-authentication#configuring-red-hat-sso-oidc)

## containers/image support

With this short time-boxed activity, it's not yet clear how `containers/image` provides support for authentication through client certificates. 

Tools like podman, skopeo and buildah all use `containers/image`. oc-mirror does too. This will make it easier to find out how to implement the support.

Although it doesn't look like it is possible to configure client certificates in the `$XDG_RUNTIME_DIR/containers/auth.json` (nor in `.docker/config`), it seems that one could use the [credentialHelpers](https://docs.docker.com/reference/cli/docker/login/#configure-credential-helpers), and set external credential helpers per registry in the registries.conf.

These [credential helpers are used](https://github.com/containers/image/blob/31d4ad14fe4da8ef3969ff67297831ab291c76f1/pkg/docker/config/config.go#L230) by `containers/image` in order to establish authentication with the remote registry.

This task is to drill down how the user should be configuring oc-mirror, and making sure that the mirroring takes the credential helpers (and certificates) into account. 

Until tested, there is no certainty on the amount of effort needed to support authentication by certificate.

**:warning: flags like `--cert-dir` and `--dest-cert-dir` of podman and skopeo resp. are for TLS certificate verification (server certificates), and not for authentication.**

## Complete support

Although in 90% of the cases oc-mirror v2 relies on `containers/image` to manipulate image, it relies on another module (go-containerregistry) as well to build the OSUS graph image.

Starting 4.18, it might rely on the same module (or yet another - under study) to build catalog images starting 4.18

This task is to ensure that these modules also support authentication by x509 certificate.

From the experience we've had to ensure go-containerregistry would support registries.conf, we know that this task may be the longest. 

This is because PRs to external repositories may take longer to merge, or even necessitate a workaround to implement a solution for oc-mirror only, outside of the repository.

# Client identity verification by mTLS

Here's a list of tasks that will be required:

| Task | Difficulty | Description|
|---|---|---|
| Test Env | Medium | Very similar to [Setup Test env](#Setup-Test-env) at high level|
| Verify `containers/image` support | Large | [containers/image support](#mTLS-containers/image-support) |
| Complete support | XLarge | Very similar to [Complete support](#mTLS-Complete-support) at high level|

## mTLS containers/image support

Today, both [podman](https://docs.podman.io/en/latest/markdown/podman-login.1.html#cert-dir-path) and [skopeo](https://github.com/containers/skopeo/blob/9ceee81a48725256bfd454fa789c692e6c7ea4bd/docs/skopeo-copy.1.md) (which also rely on `containers/image`) allow for client authentication by x509 certificates.

This hasn't been fully tested though by `podman` nor `skopeo` teams. See :link: [conversation](https://redhat-internal.slack.com/archives/CBBJY9GSX/p1726159450624639?thread_ts=1726148260.756119&cid=CBBJY9GSX), where the team seems afraid this might be bigger than just oc-mirror.

While we wait for further clarification, this task would be about verifying that creating a `--cert-dir` flag and plugging the flag value into the `--cert-dir` option of [containers/image](https://github.com/containers/image/blob/31d4ad14fe4da8ef3969ff67297831ab291c76f1/docker/docker_client.go#L225) is enough to allow for the docker client to authenticate.

According to https://github.com/containers/image/blob/main/docs/containers-certs.d.5.md, the keys and certificate corresponding to the client can also simply be in `$HOME/.config/containers/certs.d`, without need for extra flag...


